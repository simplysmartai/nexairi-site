{
  "name": "NEX_MEDIA_ORCHESTRATOR",
  "nodes": [
    {
      "parameters": {},
      "id": "trg-0",
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [-600, 60]
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "{\n  \"requests\": [\n    { \"genre\": \"Lifestyle\",  \"agent\": \"lifestyle_scout\", \"topic\": \"Holiday Evenings Reset 2.0\" }\n  ]\n}\n"
      },
      "id": "set-req",
      "name": "Set Requests",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [-420, 60]
    },
    {
      "parameters": {
        "jsCode": "const reqs = $json.requests || [];\nreturn reqs.map(r => ({ json: r }));"
      },
      "id": "split",
      "name": "Split Requests",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-240, 60]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=ROLE: You are the {{ $json.genre }} longform writer (agent: {{ $json.agent }}). Produce a fully fact-checked, human-readable article that fits the Nexairi brand.\n\nReturn ONLY JSON (no prose, no fences):\n{\n  \"title\": string,\n  \"dek\": string,\n  \"slug\": string,\n  \"tldr\": { \"bullets\": [string,string,string,string,string] },\n  \"tags\": [string],\n  \"author\": string,\n  \"body_html\": string (1500-2000 words, valid HTML with <h2>, <h3>, <p>, <ul>, <li>),\n  \"sources\": [ { \"name\": string, \"url\": string } ]\n}\n\nTOPIC: {{ $json.topic }}\nRules: specific examples, concrete steps, prefer primary sources, no hallucinations."
      },
      "id": "llm",
      "name": "Draft Article",
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.7,
      "position": [-60, 60]
    },
    {
      "parameters": {
        "jsCode": "let raw = ($json.text || $json.output || $json.data || '').toString().trim();\nif (!raw) throw new Error('No text from LLM');\nif (raw.startsWith('```')) raw = raw.replace(/^```[a-zA-Z]*\\n?/, '').replace(/```$/, '');\nlet parsed;\ntry { parsed = JSON.parse(raw); } catch (e) { throw new Error('JSON parse failed: ' + e.message); }\nif (!parsed.title || !parsed.body_html || !parsed.slug) throw new Error('Missing required fields');\nconst wc = parsed.body_html.replace(/<[^>]+>/g,' ').trim().split(/\s+/).length;\nif (wc < 1400 || wc > 2300) throw new Error('Word count out of range: ' + wc);\nreturn [{ json: parsed }];"
      },
      "id": "validate",
      "name": "Validate + Count",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [120, 60]
    },
    {
      "parameters": {
        "jsCode": "const a = $json;\nconst title = a.title;\nconst dek = a.dek || '';\nconst slug = (a.slug || (title||'nexairi-article')).toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');\nconst tags = (a.tags || []).join(' &middot; ');\nconst bullets = (a.tldr && Array.isArray(a.tldr.bullets)) ? a.tldr.bullets : [];\nconst body = a.body_html || '';\nfunction esc(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }\nconst tldrHtml = bullets.length ? '<section class=\"nx-article__tldr\"><h3>TL;DR</h3><ul class=\"nx-list\">' + bullets.map(b=>'<'+'li>'+esc(b)+'</'+'li>').join('') + '</'+'ul></section>' : '';\nconst html = '<!doctype html>' +\n'\n<html lang=\"en\">\n<head>\n  <meta charset=\"utf-8\"><meta name=\"viewport\" content=\"width=device-width,initial-scale=1\">\n  <title>'+esc(title)+' | Nexairi Mentis</title>\n  <link rel=\"stylesheet\" href=\"/css/styles.css\">\n  <link rel=\"icon\" type=\"image/png\" href=\"/Images/nexairi-mentis-favicon.png\">\n</head>\n<body>\n  <header class=\"nx-header\">\n    <div class=\"nx-header__inner\">\n      <div class=\"nx-brand\">\n        <a class=\"nx-logo-link\" href=\"/\"><img class=\"nx-logo nx-logo--full\" src=\"/Images/Nexairi Mentis_logo_banner_noBackground.png\" alt=\"Nexairi logo\"></a>\n        <div><p class=\"nx-eyebrow\">'+esc(a.genre||'')+'</p><p class=\"nx-tagline\">Human taste. Automated pace.</p></div>\n      </div>\n      <nav class=\"nx-nav\"><a href=\"/\">Home</a><a href=\"/mission\">Our Mission</a><a href=\"/lifestyle\">Lifestyle</a><a href=\"/travel\">Travel</a><a href=\"/technology\">Technology</a><a href=\"/sports\">Sports</a><a href=\"/sandbox\">Sandbox</a><a href=\"/contact\">Contact</a></nav>\n    </div>\n  </header>\n  <main class=\"nx-shell\">\n    <article class=\"nx-article\">\n      <header><h1>'+esc(title)+'</h1><p class=\"nx-dek\">'+esc(dek)+'</p></header>\n      <section class=\"nx-article__meta\"><span class=\"nx-eyebrow\">By '+esc(a.author||'Nexairi Staff')+' &middot; 8-10 min read</span></section>\n      '+tldrHtml+'\n      <section class=\"nx-article__body\">'+body+'</section>\n      <p class=\"nx-eyebrow\" style=\"margin:12px 0 8px 0;\">TAGS: '+esc(tags)+'</p>\n      <div style=\"border-top:1px solid rgba(15,23,40,0.1);margin:24px 0;\"></div>\n      <div class=\"nx-ad\" style=\"margin:0 0 16px 0;\"><strong>Ad slot</strong><span>970x250 / responsive</span></div>\n    </article>\n  </main>\n  <footer class=\"nx-footer\">\n    <div class=\"nx-shell nx-footer__wrap\">\n      <div class=\"nx-footer__links nx-footer__left\"><a href=\"/\">Home</a><a href=\"/mission\">Our Mission</a><a href=\"/lifestyle\">Lifestyle</a><a href=\"/technology\">Technology</a><a href=\"/travel\">Travel</a><a href=\"/sports\">Sports</a></div>\n      <div class=\"nx-footer__center\">&copy; 2025 Nexairi Mentis</div>\n      <div class=\"nx-footer__links nx-footer__right\"><a href=\"/sandbox\">Sandbox</a><a href=\"/contact\">Contact</a><a href=\"/privacy\">Privacy</a><a href=\"/sitemap.html\">Sitemap</a><a href=\"/sitemap.xml\">XML Sitemap</a></div>\n    </div>\n  </footer>\n</body>\n</html>';\nreturn [{ json: { html, slug, title } }];"
      },
      "id": "build",
      "name": "Build Nexairi HTML",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [300, 60]
    },
    {
      "parameters": {
        "resource": "file",
        "operation": "edit",
        "owner": { "__rl": true, "value": "simplysmartai", "mode": "name" },
        "repository": { "__rl": true, "value": "nexairi-site", "mode": "name" },
        "filePath": "={{ 'site/posts/' + ($json.slug || ($json.title || 'nexairi-article')).toString().toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'') + '.html' }}",
        "fileContent": "={{ $json.html }}",
        "commitMessage": "={{ 'Publish: ' + ($json.title || $json.slug) }}",
        "additionalParameters": { "branch": { "branch": "main" } }
      },
      "id": "github",
      "name": "Publish to GitHub",
      "type": "n8n-nodes-base.github",
      "typeVersion": 1.1,
      "position": [520, 60],
      "credentials": { "githubApi": { "id": "EOtsvSkHtHWqitqs", "name": "GitHub account" } }
    }
  ],
  "connections": {
    "Manual Trigger": { "main": [[{ "node": "Set Requests", "type": "main", "index": 0 }]] },
    "Set Requests": { "main": [[{ "node": "Split Requests", "type": "main", "index": 0 }]] },
    "Split Requests": { "main": [[{ "node": "Draft Article", "type": "main", "index": 0 }]] },
    "Draft Article": { "main": [[{ "node": "Validate + Count", "type": "main", "index": 0 }]] },
    "Validate + Count": { "main": [[{ "node": "Build Nexairi HTML", "type": "main", "index": 0 }]] },
    "Build Nexairi HTML": { "main": [[{ "node": "Publish to GitHub", "type": "main", "index": 0 }]] }
  },
  "active": false,
  "settings": { "executionOrder": "v1" },
  "versionId": "nex-media-orchestrator-min-v1",
  "id": "NEX_MEDIA_ORCHESTRATOR",
  "tags": []
}

